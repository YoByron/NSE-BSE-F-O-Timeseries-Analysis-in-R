---
title: "Markets - Data"
output: 
  html_document:
    css: "style.css"
date: "`r Sys.Date()`"
author: "Dhruv Haldar (haldar@kth.se)"
geometry: margin=2cm
---
## <span style='color: #1d7874'>Option Data
### Option Chain

```{python optionschain_p, echo=FALSE, ,echo=FALSE, error=FALSE, message=FALSE, warning=FALSE,tidy=TRUE, include=TRUE}

# Python program to print
# colored text and background
def strRed(skk):         return "\033[91m {}\033[00m".format(skk)
def strGreen(skk):       return "\033[92m {}\033[00m".format(skk)
def strYellow(skk):      return "\033[93m {}\033[00m".format(skk)
def strLightPurple(skk): return "\033[94m {}\033[00m".format(skk)
def strPurple(skk):      return "\033[95m {}\033[00m".format(skk)
def strCyan(skk):        return "\033[96m {}\033[00m".format(skk)
def strLightGray(skk):   return "\033[97m {}\033[00m".format(skk)
def strBlack(skk):       return "\033[98m {}\033[00m".format(skk)
def strBold(skk):        return "\033[1m {}\033[0m".format(skk)

# Libraries
import requests
import json
import math

# Method to get nearest strikes
def round_nearest(x,num=50): return int(math.ceil(float(x)/num)*num)
def nearest_strike_bnf(x): return round_nearest(x,100)
def nearest_strike_nf(x): return round_nearest(x,50)

# Urls for fetching Data
url_oc      = "https://www.nseindia.com/option-chain"
url_bnf     = 'https://www.nseindia.com/api/option-chain-indices?symbol=BANKNIFTY'
url_nf      = 'https://www.nseindia.com/api/option-chain-indices?symbol=NIFTY'
url_indices = "https://www.nseindia.com/api/allIndices"

# Headers
headers = {'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 Safari/537.36',
            'accept-language': 'en,gu;q=0.9,hi;q=0.8',
            'accept-encoding': 'gzip, deflate, br'}

sess = requests.Session()
cookies = dict()

# Local methods
def set_cookie():
    request = sess.get(url_oc, headers=headers, timeout=5)
    cookies = dict(request.cookies)

def get_data(url):
    set_cookie()
    response = sess.get(url, headers=headers, timeout=5, cookies=cookies)
    if(response.status_code==401):
        set_cookie()
        response = sess.get(url_nf, headers=headers, timeout=5, cookies=cookies)
    if(response.status_code==200):
        return response.text
    return ""

def set_header():
    global bnf_ul
    global nf_ul
    global bnf_nearest
    global nf_nearest
    response_text = get_data(url_indices)
    data = json.loads(response_text)
    for index in data["data"]:
        if index["index"]=="NIFTY 50":
            nf_ul = index["last"]
        if index["index"]=="NIFTY BANK":
            bnf_ul = index["last"]
    bnf_nearest=nearest_strike_bnf(bnf_ul)
    nf_nearest=nearest_strike_nf(nf_ul)

# Showing Header in structured format with Last Price and Nearest Strike

def print_header(index="",ul=0,nearest=0):
    print(strPurple( index.ljust(12," ") + " => ")+ strLightPurple(" Last Price: ") + strBold(str(ul)) + strLightPurple(" Nearest Strike: ") + strBold(str(nearest)))

def print_hr():
    print(strYellow("|".rjust(70,"-")))

# Fetching CE and PE data based on Nearest Expiry Date
def print_oi(num,step,nearest,url):
    strike = nearest - (step*num)
    start_strike = nearest - (step*num)
    response_text = get_data(url)
    data = json.loads(response_text)
    currExpiryDate = data["records"]["expiryDates"][0]
    for item in data['records']['data']:
        if item["expiryDate"] == currExpiryDate:
            if item["strikePrice"] == strike and item["strikePrice"] < start_strike+(step*num*2):
                #print(strCyan(str(item["strikePrice"])) + strGreen(" CE ") + "[ " + strBold(str(item["CE"]["openInterest"]).rjust(10," ")) + " ]" + strRed(" PE ")+"[ " + strBold(str(item["PE"]["openInterest"]).rjust(10," ")) + " ]")
                print(data["records"]["expiryDates"][0] + " " + str(item["strikePrice"]) + " CE " + "[ " + strBold(str(item["CE"]["openInterest"]).rjust(10," ")) + " ]" + " PE " + "[ " + strBold(str(item["PE"]["openInterest"]).rjust(10," ")) + " ]")
                strike = strike + step

# Finding highest Open Interest of People in CE based on CE data         
def highest_oi_CE(num,step,nearest,url):
    strike = nearest - (step*num)
    start_strike = nearest - (step*num)
    response_text = get_data(url)
    data = json.loads(response_text)
    currExpiryDate = data["records"]["expiryDates"][0]
    max_oi = 0
    max_oi_strike = 0
    for item in data['records']['data']:
        if item["expiryDate"] == currExpiryDate:
            if item["strikePrice"] == strike and item["strikePrice"] < start_strike+(step*num*2):
                if item["CE"]["openInterest"] > max_oi:
                    max_oi = item["CE"]["openInterest"]
                    max_oi_strike = item["strikePrice"]
                strike = strike + step
    return max_oi_strike

# Finding highest Open Interest of People in PE based on PE data 
def highest_oi_PE(num,step,nearest,url):
    strike = nearest - (step*num)
    start_strike = nearest - (step*num)
    response_text = get_data(url)
    data = json.loads(response_text)
    currExpiryDate = data["records"]["expiryDates"][0]
    max_oi = 0
    max_oi_strike = 0
    for item in data['records']['data']:
        if item["expiryDate"] == currExpiryDate:
            if item["strikePrice"] == strike and item["strikePrice"] < start_strike+(step*num*2):
                if item["PE"]["openInterest"] > max_oi:
                    max_oi = item["PE"]["openInterest"]
                    max_oi_strike = item["strikePrice"]
                strike = strike + step
    return max_oi_strike

set_header()
#print('\033c')
#print_hr()
print("Nifty")
#print_hr()
print_oi(10,50,nf_nearest,url_nf)
#print_hr()
print("Bank Nifty")
#print_hr()
print_oi(10,100,bnf_nearest,url_bnf)
#print_hr()

# Finding Highest OI in Call Option In Nifty
nf_highestoi_CE = highest_oi_CE(10,50,nf_nearest,url_nf)

# Finding Highest OI in Put Option In Nifty
nf_highestoi_PE = highest_oi_PE(10,50,nf_nearest,url_nf)

# Finding Highest OI in Call Option In Bank Nifty
bnf_highestoi_CE = highest_oi_CE(10,100,bnf_nearest,url_bnf)

# Finding Highest OI in Put Option In Bank Nifty
bnf_highestoi_PE = highest_oi_PE(10,100,bnf_nearest,url_bnf)

```

```{r include=FALSE}
library(reticulate)
```


```{r oi_p, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, include=TRUE}

```                
## Option Chain Technical Analysis {#option-technical-analysis}

| Option Property            | Value                   |
|----------------------------|-------------------------|
| Nifty Last Price           | `r factor(py$nf_ul)`    |
| Nifty Nearest Strike       | `r py$nf_nearest`       |
| Nifty Major Support        | `r py$nf_highestoi_CE`  |
| Nifty Major Resistance     | `r py$nf_highestoi_PE`  |
| BankNifty Last Price       | `r factor(py$bnf_ul)`   |
| BankNifty Nearest Strike   | `r py$bnf_nearest`      |
| BankNifty Major Support    | `r py$bnf_highestoi_CE` |
| Banknifty Major Resistance | `r py$bnf_highestoi_PE` |

### <span style='color: #1d7874'> FII & DII Trading Activity

```{r fiidii, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, include=TRUE}
packages <- function()
{# Package names
packages <- c("ggplot2", 
              #"bslib",
              #"shiny",
              "readxl", "nser", "lattice", 
                "reshape2", 
                #"hablar", 
                "dplyr", 
                #"tidyquant",
                "tidyverse", 
                "scales",
                "padr",
                #"purrr",
                #"svDialogs",
                "utils", 
                "quantmod",
              "broom", 
              #"magrittr",
                "diffr", 
                #"diffobj",
                "alphavantager",
                "plotly",
                "ggpubr",
                #"derivmkts",
                #"TTR",
                "optionstrat",
                #"knitr",
                #"rmarkdown",
              "PerformanceAnalytics",
              "dygraphs",
                "nse2r"
                )
  
# Install packages not yet installed
installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
    install.packages(packages[!installed_packages])
  }
  
# Packages loading
invisible(lapply(packages, library, character.only = TRUE))
  
# Alpha Vantage API key
api_key="MB7IR06HYB54IUJG"
av_api_key(api_key)
  }

netFIIDIIfn <- function(fdii) #function
{
date = fdii[3:20,1]
date <- gsub("-", "", date)                        # Applying gsub function
date = as.Date(date, "%d%b%y")


net_FII = fdii[3:20,4]
net_FII = factor(net_FII)
net_FII <- gsub(",","", net_FII)                   # Applying gsub function
options(digits=7)
net_FII=as.double(net_FII)

net_DII = fdii[3:20,7]
net_DII = factor(net_DII)
net_DII <- gsub(",","", net_DII)                   # Applying gsub function
options(digits=7)
net_DII=as.double(net_DII)

fdii_main <- data.frame(date,net_FII,net_DII)

#netFII+netDII
fig.align = 'right'
p <- ggplot(fdii_main,
            aes(x = date, y = net_FII+net_DII)) +
  geom_text(aes(label=net_FII+net_DII),
            vjust=0.006,
            size=3.5,
            color="#DAF7A6")+
  scale_x_date(date_labels="%b %d",date_breaks  ="1 day") +
  labs(x = "Date",
       title = "Gross Purchase FII+DII (Crores)",
       y = "Gross Purchase (Crores)",
       subtitle = paste("Last updated",Sys.time())
  )

p+ theme(
  panel.background = element_rect(fill = "lightblue",
                                colour = "lightblue",
                                size = 0.5, linetype = "solid"),
  panel.grid.major = element_line(size = 0.5, linetype = 'solid',
                                colour = "white"), 
  panel.grid.minor = element_line(size = 0.25, linetype = 'solid',
                                colour = "white")
  )

p+ geom_bar(aes(fill = net_FII+net_DII > 0), stat = "identity") +
  scale_fill_manual(
    guide = "none",
    breaks = c(TRUE, FALSE),
    values=c("green", "red"))}
```

```{r nse_general, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, include=TRUE}
data_bhavtoday_nser <- function() #function
{
  get_data <- function(get_data) 
    {
#FO Bhavcopy Today (updated every evening,not working in weekend)
    fobhavtoday <-- fobhavtoday()

#Indices Data
    fo_indices = fobhavtoday[1:19,]
    }
  get_data2 <- possibly(get_data, otherwise = NA)
  fobhavtoday
  }

# FO Bhavcopy Hist. (1 Jan 2016 Onwards)
Hist_date=28042022
data_bhavtoday_nser <- function() #function
{
  fobhavhist = fobhav(Hist_date)
  bhavhist = bhav(Hist_date)
  fobhavhist
}

# Heatmap
markets_heatmap <- function() #function
{
  nsetree = nsetree()
}
fo_heatmap <- function() #function
{
  nsetreefo = nsetree("fo")
}

# NSE Indices today
cashmarkets_stocks <- function() #function
{
  nseindex = nseindex()
  nseindex_name = nseindex[1:55,1]
  nseindex_change = nseindex[1:55,4]
  nseindex = nse_index_quote(clean_names = TRUE)

#Stock symbol list
  nsestockcode = nse_stock_code(clean_names = TRUE)

#Stock price
  stock_code="SCHAEFFLER"
  stock_price = nse_stock_quote(stock_code, source = c("yahoo",
                                                       "rediff"))
  print(paste(stock_code,"is trading at",
            stock_price,"INR at NSE",", last updated",Sys.time()))

#52 Week high
  nseyearhigh = nse_stock_year_high(clean_names = TRUE)
#52 Week low
  nseyearlow = nse_stock_year_low(clean_names = TRUE)
#Most Traded Stocks
  nsemosttraded = nse_stock_most_traded(clean_names = TRUE)
#Top Gainers
  nsetopgainers = nse_stock_top_gainers(clean_names = TRUE)
#Top Losers
  nsetoplosers = nse_stock_top_losers(clean_names = TRUE)
}

jugaad_data <- function() #function
{ 
  #date_df= df[1:12625,1]
  #price_df= df[1:12625,2]
  #dateprice_df <- data.frame(date_df,price_df)
  }

##Data 
#symbol="MARUTI" #fix in python file

#enable other funtions later

#Function Calls
packages()
fdii = fdii()
netFIIDIIfn(fdii)
#fo_heatmap()
#markets_heatmap()
#data_bhavtoday_nser()
#cashmarkets_stocks()
#EOC
```

## <span style='color: #1d7874'>Preopen NSE FO Markets

### <span style='color: #73C1C6'> NSE FO Top Gainers

```{r nse_fo_top_gainers, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE,escape = FALSE}
options(warn=-1) #supress coercion warnings, fix later
  #nseopen_fo = nseopen("fo") #FO stocks
library(kableExtra)

#nse_fo_top_gainers$percent_change=  cell_spec(nse_fo_top_gainers$percent_change, color = ifelse(nse_fo_top_gainers$percent_change > 0.1, "red", "blue"))

knitr::kable(nse_fo_top_gainers(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "600px")
```

### <span style='color: #FC5130'> NSE FO Top Losers

```{r nse_fo_top_losers, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
knitr::kable(nse_fo_top_losers(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "600px")
```

## <span style='color: #1d7874'> NSE Indices

### Preopen Nifty

```{r nse_preopen_nifty, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE}
knitr::kable(nse_preopen_nifty(clean_names = TRUE))%>% #preopen NIFTY
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "600px")
```

### Preopen Nifty Bank

```{r nse_preopen_niftybk, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_preopen_nifty_bank(clean_names = TRUE))%>% #preopen 
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "50%")
```

### NSE Index

```{r nse_index, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_index_quote(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "50%", height = "200px")
```

## <span style='color: #1d7874'> Most Traded Stocks {#span-stylecolor-1d7874-most-traded-stocks}

```{r nse_most_traded, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_stock_most_traded(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "80%", height = "50%")
```

## <span style='color: #1d7874'>NSE IPO

```{r nse_ipo, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
#knitr::kable(nselive()) #Nifty stocks
knitr::kable(nseipo())%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)
```

## <span style='color: #1d7874'>NSE Cash Market

### 52 Week high

```{r 52wkhigh, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_stock_year_high(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "600px")
```

### 52 Week low

```{r 52wklow, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_stock_year_low(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "600px")
```

### Top Gainers

```{r topgainers, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_stock_top_gainers(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "400px")
```

### Top Losers

```{r toplosers, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
knitr::kable(nse_stock_top_losers(clean_names = TRUE))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "100%", height = "400px")
```

```{python nifty_pe_python, include=TRUE, echo=FALSE, tidy=TRUE}
#Python Nifty PE Script
#pip install nsepy
from datetime import date
# Index P/E ratio history
from nsepy import get_index_pe_history
nifty_pe = get_index_pe_history(symbol="NIFTY",
                                start=date(2015,1,1),
                                end=date(2015,1,10))
```

## NIFTY PE

```{r nifty_pe_r, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='asis', tidy=TRUE}
pythonr <- py$nifty_pe
knitr::kable(pythonr)%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = F
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "170px", height = "350px")
```

## <span style='color: #1d7874'>RBI Current Data

```{python rbidata_python, include=TRUE, echo=FALSE, tidy=TRUE}
from jugaad_data.rbi import RBI
r = RBI()
rbi = r.current_rates()
```

```{r rbidata_r, echo=FALSE, error=FALSE, warning=FALSE, paged.print=FALSE, results='hold', tidy=TRUE}
python_rbi_value <- py$rbi
python_rbi_value[8:11] <- NULL
python_rbi_value[22:23] <- NULL
python_rbi_value <- unlist(python_rbi_value)

knitr::kable(python_rbi_value,
             col.names = c("Values"))%>%
  kable_styling(bootstrap_options = "condensed",
                , full_width = T
                ,font_size = 12,
                fixed_thead = T)%>%
scroll_box(width = "310px", height = "600px")
```

```{r , include=TRUE, echo=FALSE, tidy=TRUE}
py$symbol <- "INFY"
```

## <span style='color: #1d7874'> `r py$symbol` Stock Price Chart

```{python , include=TRUE, echo=FALSE, tidy=TRUE}

from datetime import datetime
from requests import Session
import pandas as pd
#import click
#mport csv

page_url = "https://www.nseindia.com/get-quotes/equity?symbol=LT"
chart_data_url = "https://www.nseindia.com/api/chart-databyindex"

s = Session()
h = {"user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36",
     "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8",
    "accept-encoding": "gzip, deflate, br",
    "accept-language": "en-GB,en-US;q=0.9,en;q=0.8",
    }
s.headers.update(h)
r = s.get(page_url)
#symbol = "INFY"

def fetch_data(symbol):
    data = {"index": symbol + "EQN"}
    r = s.get(chart_data_url, params=data)
    data = r.json()['grapthData']
    return [[datetime.utcfromtimestamp(d[0]/1000),d[1]] for d in data]
d = fetch_data(symbol)
df = pd.DataFrame(d)
df.columns = ['Time', "Price"]
df.index = df['Time'].dt.time
df['Price'].plot(figsize=(12,6), grid=True)

```
## R version
```{r jugaad-data_r, include=FALSE, echo=FALSE, tidy=TRUE}
## Visualize
library(reticulate)
library(tidyverse)
library(tidyquant) 
pydf <- py$df
pydf_date <- py$df[1:1752,1]
pydf_price <- py$df[1:1752,2]
pydf <- data.frame(pydf_date,pydf_price)

title = paste(py$symbol,"Line Chart")
pydf %>%
    ggplot(aes(x = pydf_date, y = pydf_price)) +
    geom_line() +
    labs(title = title, y = "Closing Price", x = "") + 
    theme_tq()
```

## Stock Portfolio

```{r stock_portfolio, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, include=TRUE}
monthly_returns <- function(ticker, base_year)
{
  # Obtain stock price data from Yahoo! Finance
  stock <- getSymbols(ticker, src = "yahoo", auto.assign = FALSE) 
  # Remove missing values
  stock <- na.omit(stock)
  # Keep only adjusted closing stock prices
  stock <- stock[, 6]
  
  # Confine our observations to begin at the base year and end at the last available trading day
  horizon <- paste0(as.character(base_year), "/", as.character(Sys.Date()))
  stock <- stock[horizon]
  
  # Calculate monthly arithmetic returns
  data <- periodReturn(stock, period = "monthly", type = "arithmetic")
  
  # Assign to the global environment to be accessible
  assign(ticker, data, envir = .GlobalEnv)
}

# Call our function for each stock
monthly_returns("SBUX", 2015)
monthly_returns("CCL", 2015)
monthly_returns("AAPL", 2015)

# Get S&P 500 Data
monthly_returns("SPY", 2015)

# Merge all the data and rename columns
returns <- merge.xts(SBUX, CCL, AAPL, SPY)
colnames(returns) <- c("SBUX", "CCL", "AAPL", "SP500")

# Produce interactive chart of stock returns
dygraph(returns, main = "Starbucks vs. Carnival vs. Apple vs. S&P 500") %>%
  dyAxis("y", label = "Return", valueRange = c(-1,0.5)) %>%
  dyRangeSelector(dateWindow = c("2015-01-01", "2020-07-01")) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set2")) 

# Print last 5 rows of the data, rounded to 4 decimal places
round(tail(returns, n = 5), 4)

# Assign weights
wts <- c(1/3, 1/3, 1/3)

# Construct a portfolio using our returns object and weights
# Only select first three columns to isolate our individual stock data
portfolio_returns <- Return.portfolio(R = returns[,1:3], weights = wts, wealth.index = TRUE)

# Then isolate our S&P 500 data
benchmark_returns <- Return.portfolio(R = returns[,4], wealth.index = TRUE)

# Merge the two
comp <- merge.xts(portfolio_returns, benchmark_returns)
colnames(comp) <- c("Portfolio", "Benchmark")

# Build an interactive graph to compare performance
dygraph(comp, main = "Portfolio Performance vs. Benchmark") %>%
  dyAxis("y", label = "Amount ($)")
```

## Implement later <https://stackoverflow.com/questions/32906263/how-to-knit-pdf-from-rmd-script-by-clicking-an-executable-r-file>

## NSE Fundamentals do later

```{r nsefundamentals, echo=FALSE, error=FALSE, message=FALSE, warning=FALSE, include=TRUE}
get.nse.ratios <- function(index.nse = 'NIFTY 50', date.start = as.Date('2001-01-01'), date.end = as.Date(Sys.time())){
  # url.base <- 'https://www1.nseindia.com/products/content/equities/indices/historical_pepb.htm'
  index.nse <- gsub(' ', '%20', index.nse)
  
  # Split Date range into acceptable range
  max.history.constraint <- 100
  dates.start <- seq.Date(date.start, date.end, by = max.history.constraint)
  data.master <- data.frame()
  # Loop over sub-periods to extract data
  for(fromDate in dates.start){
    toDate <- min(fromDate+(max.history.constraint - 1), as.Date(Sys.Date()))
    
    cat(sprintf('Fetching data from %s to %s \n', as.Date(fromDate), as.Date(toDate)))
    # browser()
    # Reformat dates
    fromDate <- format.Date(as.Date(fromDate), '%d-%m-%Y')
    toDate <- format.Date(as.Date(toDate), '%d-%m-%Y')
    
    # Infer url for sub-period
    url.sub <- sprintf("https://www1.nseindia.com/products/dynaContent/equities/indices/historical_pepb.jsp?indexName=%s&fromDate=%s&toDate=%s&yield1=undefined&yield2=undefined&yield3=undefined&yield4=all", index.nse, fromDate, toDate)
    
    # Scrape table from inferred url
    data.sub <- rvest::html_table(xml2::read_html(url.sub))[[1]]
    
    # Clean the table
    names.columns <- unname(unlist(data.sub[2,]))
    data.clean <- data.sub[3:(nrow(data.sub)-1),]
    colnames(data.clean) <- names.columns
    data.clean$Date <- as.Date(data.clean$Date, format = '%d-%b-%Y')
    cols.num <- names(which(sapply(data.clean, class) == 'character'))
    data.clean[cols.num] <- sapply(data.clean[cols.num],as.numeric)
    
    # Append to master data
    data.master <- rbind(data.master, data.clean)

  }
  
  data.master
}
```
